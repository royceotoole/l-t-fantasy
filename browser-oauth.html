<!DOCTYPE html>
<html>
<head>
  <title>Yahoo OAuth Token Generator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1 {
      color: #333;
    }
    .input-group {
      margin: 15px 0;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
      color: #555;
    }
    input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .button {
      background: #007bff;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 5px 10px 0;
    }
    .button:hover {
      background: #0056b3;
    }
    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
      color: #856404;
    }
    .success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
      color: #721c24;
    }
    .token {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      word-break: break-all;
      font-family: monospace;
      margin: 10px 0;
      font-size: 12px;
    }
    code {
      background: #f8f9fa;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
    ol {
      padding-left: 20px;
    }
    ol li {
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>üèí Yahoo OAuth Token Generator</h1>
    <p>Get your Yahoo refresh token for the Fantasy Hockey API</p>
  </div>

  <div id="step1" class="card">
    <h2>Step 1: Enter Your Credentials</h2>
    <div class="input-group">
      <label>Yahoo Client ID:</label>
      <input type="text" id="clientId" placeholder="Your Yahoo Client ID">
    </div>
    <div class="input-group">
      <label>Yahoo Client Secret:</label>
      <input type="text" id="clientSecret" placeholder="Your Yahoo Client Secret">
    </div>
    <div class="warning">
      ‚ö†Ô∏è <strong>IMPORTANT:</strong> Before clicking the button below:
      <ol>
        <li>Open <a href="https://hockey.fantasysports.yahoo.com/hockey/37256" target="_blank">your Hockey league</a> in another tab</li>
        <li>Make sure you're logged in as <strong>royceotoole@gmail.com</strong></li>
        <li>Keep that tab open</li>
        <li>Then come back here and click "Get Authorization Code"</li>
      </ol>
    </div>
    <button class="button" onclick="startAuth()">üîë Get Authorization Code</button>
  </div>

  <div id="step2" class="card" style="display: none;">
    <h2>Step 2: Enter Authorization Code</h2>
    <p>After authorizing, Yahoo will redirect you to a page that can't be reached. That's OK!</p>
    <p><strong>Copy the entire URL from your browser's address bar and paste it below:</strong></p>
    <div class="input-group">
      <label>Paste the full redirect URL:</label>
      <input type="text" id="redirectUrl" placeholder="https://oauth.pstmn.io/v1/callback?code=...">
    </div>
    <button class="button" onclick="exchangeToken()">üîÑ Get Refresh Token</button>
  </div>

  <div id="step3" class="card" style="display: none;">
    <h2>‚úÖ Success! Here's Your Refresh Token</h2>
    <div class="success">
      <p><strong>Refresh Token:</strong></p>
      <div class="token" id="refreshToken"></div>
      <button class="button" onclick="copyToken()">üìã Copy Token</button>
    </div>
    <div class="warning">
      <h3>Next Steps:</h3>
      <ol>
        <li>Copy the refresh token above</li>
        <li>Go to Vercel ‚Üí Environment Variables</li>
        <li>Update <code>YAHOO_REFRESH_TOKEN</code> with this value</li>
        <li>Redeploy your app</li>
        <li>Visit <code>/discover-nhl</code> to find your league key</li>
      </ol>
    </div>
  </div>

  <div id="error" class="card" style="display: none;">
    <div class="error">
      <h3>‚ùå Error</h3>
      <p id="errorMessage"></p>
    </div>
    <button class="button" onclick="location.reload()">üîÑ Start Over</button>
  </div>

  <script>
    let clientId, clientSecret;

    function startAuth() {
      clientId = document.getElementById('clientId').value.trim();
      clientSecret = document.getElementById('clientSecret').value.trim();

      if (!clientId || !clientSecret) {
        showError('Please enter both Client ID and Client Secret');
        return;
      }

      // Save to localStorage
      localStorage.setItem('yahoo_client_id', clientId);
      localStorage.setItem('yahoo_client_secret', clientSecret);

      // Build authorization URL
      const params = new URLSearchParams({
        client_id: clientId,
        redirect_uri: 'https://oauth.pstmn.io/v1/callback',
        response_type: 'code',
        scope: 'fspt-r'
      });

      const authUrl = `https://api.login.yahoo.com/oauth2/request_auth?${params.toString()}`;

      // Open in new window
      window.open(authUrl, '_blank');

      // Show step 2
      document.getElementById('step1').style.display = 'none';
      document.getElementById('step2').style.display = 'block';
    }

    async function exchangeToken() {
      const redirectUrl = document.getElementById('redirectUrl').value.trim();

      if (!redirectUrl) {
        showError('Please paste the redirect URL');
        return;
      }

      // Extract code from URL
      const url = new URL(redirectUrl);
      const code = url.searchParams.get('code');

      if (!code) {
        showError('Could not find authorization code in URL. Make sure you copied the entire URL.');
        return;
      }

      // Get credentials from localStorage
      clientId = localStorage.getItem('yahoo_client_id');
      clientSecret = localStorage.getItem('yahoo_client_secret');

      if (!clientId || !clientSecret) {
        showError('Session expired. Please start over.');
        return;
      }

      try {
        // Exchange code for tokens
        const body = new URLSearchParams({
          grant_type: 'authorization_code',
          redirect_uri: 'https://oauth.pstmn.io/v1/callback',
          code: code
        });

        const auth = btoa(`${clientId}:${clientSecret}`);

        const response = await fetch('https://api.login.yahoo.com/oauth2/get_token', {
          method: 'POST',
          headers: {
            'Authorization': `Basic ${auth}`,
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: body
        });

        if (!response.ok) {
          const error = await response.text();
          showError(`Token exchange failed: ${error}`);
          return;
        }

        const data = await response.json();

        // Show refresh token
        document.getElementById('refreshToken').textContent = data.refresh_token;
        document.getElementById('step2').style.display = 'none';
        document.getElementById('step3').style.display = 'block';

      } catch (error) {
        showError(`Network error: ${error.message}`);
      }
    }

    function copyToken() {
      const token = document.getElementById('refreshToken').textContent;
      navigator.clipboard.writeText(token);
      alert('‚úÖ Token copied to clipboard!');
    }

    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('error').style.display = 'block';
    }

    // Check if returning from OAuth (has client credentials in localStorage)
    window.onload = function() {
      const savedClientId = localStorage.getItem('yahoo_client_id');
      const savedClientSecret = localStorage.getItem('yahoo_client_secret');

      if (savedClientId && savedClientSecret) {
        document.getElementById('clientId').value = savedClientId;
        document.getElementById('clientSecret').value = savedClientSecret;
      }
    };
  </script>
</body>
</html>

